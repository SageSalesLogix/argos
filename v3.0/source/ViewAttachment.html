<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*
 * Copyright (c) 1997-2013, SalesLogix, NA., LLC. All rights reserved.
 */

<span id='Mobile-SalesLogix-Views-Attachment-ViewAttachment'>/**
</span> * @class Mobile.SalesLogix.Views.Attachment.ViewAttachment
 *
 *
 * @extends Sage.Platform.Mobile.Detail
 * @mixins Sage.Platform.Mobile.Detail
 * @mixins Sage.Platform.Mobile._LegacySDataDetailMixin
 *
 * @requires Sage.Platform.Mobile.Detail
 * @requires Sage.Platform.Mobile._LegacySDataDetailMixin
 *
 * @requires Mobile.SalesLogix.Format
 * @requires Mobile.SalesLogix.AttachmentManager
 * @requires Mobile.SalesLogix.Utility
 *
 */
define('Mobile/SalesLogix/Views/Attachment/ViewAttachment', [
    'dojo/_base/declare',
    'dojo/string',
    'dojo/_base/connect',
    'dojo/_base/array',
    'Mobile/SalesLogix/Format',
    'dojo/dom-construct',
    'dojo/dom-attr',
    'dojo/dom-class',
    'dojo/has',
    'dojo/dom',
    'dojo/dom-geometry',
    'Mobile/SalesLogix/AttachmentManager',
    'Mobile/SalesLogix/Utility',
    'Sage/Platform/Mobile/Detail',
    'Sage/Platform/Mobile/_LegacySDataDetailMixin'
], function(
    declare,
    string,
    connect,
    array,
    format,
    domConstruct,
    domAttr,
    domClass,
    has,
    dom,
    domGeom,
    AttachmentManager,
    Utility,
    Detail,
    _LegacySDataDetailMixin
) {

    return declare('Mobile.SalesLogix.Views.Attachment.ViewAttachment', [Detail, _LegacySDataDetailMixin], {
        //Localization
        detailsText: 'Attachment Details',
        descriptionText: 'description',
        fileNameText: 'file name',
        attachDateText: 'attachment date',
        fileSizeText: 'file size',
        userText: 'user',
        newWindowText: 'Open in new window',
        attachmentNotSupportedText: 'The attachment type is not supported for viewing.',
        attachmentDateFormatText: 'ddd M/D/YYYY h:mm a',
        //View Properties
        id: 'view_attachment',
        editView: '',
        downloadingText:'Downloading attachment ...',
        security: null,
        querySelect: ['description', 'user', 'attachDate', 'fileSize', 'fileName', 'url', 'fileExists', 'remoteStatus', 'dataType'],
        resourceKind: 'attachments',
        contractName: 'system',
        icon: 'content/images/icons/Scale_24.png',
        orginalImageSize: { width: 0, height: 0 },
        queryInclude: ['$descriptors'],
        dataURL: null,
        widgetTemplate: new Simplate([
            '&lt;div id=&quot;{%= $.id %}&quot; title=&quot;{%= $.titleText %}&quot; class=&quot;overthrow detail panel {%= $.cls %}&quot; {% if ($.resourceKind) { %}data-resource-kind=&quot;{%= $.resourceKind %}&quot;{% } %}&gt;',
            '{%! $.loadingTemplate %}',
            '&lt;div class=&quot;panel-content&quot; data-dojo-attach-point=&quot;contentNode&quot;&gt;&lt;/div&gt;',
            '&lt;div class=&quot;attachment-viewer-content&quot; data-dojo-attach-point=&quot;attachmentViewerNode&quot;&gt;&lt;/div&gt;',
            '&lt;/div&gt;'
        ]),
        attachmentLoadingTemplate: new Simplate([
            '&lt;div class=&quot;list-loading-indicator&quot;&gt;{%= $.loadingText %}&lt;/div&gt;'
        ]),
        attachmentViewTemplate: new Simplate([
            '&lt;div class=&quot;attachment-viewer-label&quot; style=&quot;white-space:nowrap;&quot;&gt;',
                '&lt;label&gt;{%= $.description + &quot; (&quot; + $.fileType + &quot;)&quot;  %}&lt;/label&gt;',
            '&lt;/div&gt;',
            '&lt;div class=&quot;attachment-viewer-area&quot;&gt;',
                '&lt;button class=&quot;button&quot; data-action=&quot;openNewWindow&quot;&gt;{%: $$.newWindowText %}&lt;/button&gt;',
                '&lt;iframe id=&quot;attachment-Iframe&quot; src=&quot;{%= $.url %}&quot;&gt;&lt;/iframe&gt;',
            '&lt;/div&gt;'
        ]),
        attachmentViewImageTemplate: new Simplate([
           '&lt;div class=&quot;attachment-viewer-label&quot; style=&quot;white-space:nowrap;&quot;&gt;',
               '&lt;label&gt;{%= $.description + &quot; (&quot; + $.fileType + &quot;)&quot;  %}&lt;/label&gt;',
           '&lt;/div&gt;',
           '&lt;div class=&quot;attachment-viewer-area&quot;&gt;',
               '&lt;table&gt;&lt;tr valign=&quot;middle&quot;&gt;&lt;td align=&quot;center&quot;&gt;',
                   '&lt;image id=&quot;attachment-image&quot; border=&quot;1&quot;&gt;&lt;/image&gt;',
               '&lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;',
           '&lt;/div&gt;'
        ]),
        attachmentViewNotSupportedTemplate: new Simplate([
                '&lt;div class=&quot;attachment-viewer-label&quot;&gt;',
                '&lt;label&gt;{%= $$.attachmentNotSupportedText %}&lt;/label&gt;',
                '&lt;/div&gt;',
                '&lt;div class=&quot;attachment-viewer-not-supported&quot;&gt;',
                '&lt;h3&gt;&lt;span&gt;{%: $.description %}&amp;nbsp;&lt;/span&gt;&lt;/h3&gt;',
                '&lt;h4&gt;&lt;span&gt;({%: Mobile.SalesLogix.Format.date($.attachDate, $$.attachmentDateFormatText) %})&amp;nbsp;&lt;/span&gt;',
                '&lt;span&gt;{%: Mobile.SalesLogix.Format.fileSize($.fileSize) %} &lt;/span&gt;&lt;/h4&gt;',
                '&lt;h4&gt;&lt;span&gt;{%: Mobile.SalesLogix.Utility.getFileExtension($.fileName) %} &lt;/span&gt;&lt;/h4&gt;',
                '{% if($.user) { %}',
                    '&lt;h4&gt;&lt;span&gt;{%: $.user.$descriptor  %}&lt;/span&gt;&lt;/h4&gt;',
               '{% } %}',
               '&lt;/div&gt;'
        ]),

        downloadingTemplate: new Simplate([
            '&lt;li class=&quot;list-loading-indicator&quot;&gt;&lt;div&gt;{%= $.downloadingText %}&lt;/div&gt;&lt;/li&gt;'
        ]),
        show: function(options) {
            this.inherited(arguments);
            this.attachmentViewerNode.innerHTML = &quot;&quot;;
            //If this opened the second time we need to check to see if it is the same attachmnent and let the Process Entry function load the view.
            if (this.entry) {
                if (options.key === this.entry.$key) {
                    this._loadAttachmentView(this.entry);
                }
            }
        },
        processEntry: function(entry) {
            this.inherited(arguments);
            this._loadAttachmentView(entry);
        },
        createRequest: function() {
            var request = this.inherited(arguments);
            request.setQueryArg('_includeFile', 'false');
            return request;
        },
        createEntryForDelete: function(e) {
            var entry = {
                '$key': e['$key'],
                '$etag': e['$etag'],
                '$name': e['$name']
            };
            return entry;
        },
        createToolLayout: function() {
            return this.tools;
        },
        createLayout: function() {
             return this.tools || (this.tools = []);
        },
        openNewWindow: function() {
            console.log(this.dataURL);
            if (this.dataURL) {
                window.open(this.dataURL);
            }
        },
        _loadAttachmentView: function(entry) {
            var data, am, isFile, url, viewNode, tpl, dl, description, attachmentid,fileType, self, iframe;

            am = new AttachmentManager();

            if (!entry.url) {
                description = entry.description;
                fileType = Utility.getFileExtension(entry.fileName);
                isFile = true;
            } else {
                isFile = false;
                description = entry.description + ' (' + entry.url + ')';
                fileType = 'url';
            }

            data = {
                fileName: entry.fileName,
                fileSize: entry.fileSize,
                fileType: fileType,
                url: '',
                description: description
            };

            if (isFile) {
                fileType = Utility.getFileExtension(entry.fileName);
                if (this._isfileTypeAllowed(fileType)) {
                    if (this._isfileTypeImage(fileType)) {
                        viewNode = domConstruct.place(this.attachmentViewImageTemplate.apply(data, this), this.attachmentViewerNode, 'last');
                        tpl = this.downloadingTemplate.apply(this);
                        dl = domConstruct.place(tpl, this.attachmentViewerNode, 'first');
                        domClass.add(this.domNode, 'list-loading');
                        self = this;
                        attachmentid = entry.$key;
                        //dataurl
                        am.getAttachmentFile(attachmentid, 'arraybuffer', function(responseInfo) {
                            var rData, url, a, image;

                            rData = Utility.base64ArrayBuffer(responseInfo.response);
                            self.dataURL = 'data:' + responseInfo.contentType + ';base64,' + rData;
                            image = dom.byId('attachment-image');
                            image.onload = function() {
                                self._orginalImageSize = { width: image.width, height: image.height };
                                self._sizeImage(self.domNode, image);
                            };
                            domAttr.set(image, 'src', self.dataURL);
                            domClass.add(dl, 'display-none');
                        });
                    } else { //View file type in Iframe
                        if (this._viewImageOnly() === false) {
                            viewNode = domConstruct.place(this.attachmentViewTemplate.apply(data, this), this.attachmentViewerNode, 'last');
                            tpl = this.downloadingTemplate.apply(this);
                            dl = domConstruct.place(tpl, this.attachmentViewerNode, 'first');
                            domClass.add(this.domNode, 'list-loading');
                            self = this;
                            attachmentid = entry.$key;
                            am.getAttachmentFile(attachmentid, 'arraybuffer', function(responseInfo) {
                                var rData, url, a, iframe;

                                rData = Utility.base64ArrayBuffer(responseInfo.response);
                                self.dataURL = 'data:' + responseInfo.contentType + ';base64,' + rData;
                                domClass.add(dl, 'display-none');
                                iframe = dom.byId('attachment-Iframe');
                                iframe.onload = function() {
                                    domClass.add(dl, 'display-none');
                                };
                                domClass.add(dl, 'display-none');
                                domAttr.set(iframe, 'src', self.dataURL);
                            });
                        } else { //Only view images
                            viewNode = domConstruct.place(this.attachmentViewNotSupportedTemplate.apply(entry, this), this.attachmentViewerNode, 'last');
                        }
                    }
                } else { //File type not allowed 
                    viewNode = domConstruct.place(this.attachmentViewNotSupportedTemplate.apply(entry, this), this.attachmentViewerNode, 'last');
                }

            } else { // url Attachment
                viewNode = domConstruct.place(this.attachmentViewTemplate.apply(data, this), this.attachmentViewerNode, 'last');
                url = am.getAttachmenturlByEntity(entry);
                domClass.add(this.domNode, 'list-loading');
                tpl = this.downloadingTemplate.apply(this);
                dl = domConstruct.place(tpl, this.attachmentViewerNode, 'first');
                iframe = dom.byId('attachment-Iframe');
                iframe.onload = function() {
                    domClass.add(dl, 'display-none');
                };
                domAttr.set(iframe, 'src', url);
                domClass.add(dl, 'display-none');
            }

        },
        _isfileTypeImage: function(fileType){
            var imageTypes;
            fileType = fileType.substr(fileType.lastIndexOf('.') + 1).toLowerCase();
            if (App.imageFileTypes) {
                imageTypes = App.imageFileTypes;
            } else {
                imageTypes = { jpg: true, gif: true, png: true, bmp: true, tif: true };
            }
            if (imageTypes[fileType]) {
                return true;
            }
            return false;
        },
        _isfileTypeAllowed: function(fileType) {
            var fileTypes;
            fileType = fileType.substr(fileType.lastIndexOf('.') + 1).toLowerCase();
            if (App.nonViewableFileTypes) {
                fileTypes = App.nonViewableFileTypes;
            } else {
                fileTypes = { exe: true, dll: true };
            }
            if (fileTypes[fileType]) {
                return false;
            }
            return true;
        },
        _viewImageOnly: function(){
            return false;
        },
        _sizeImage: function (containerNode,image) {
            var wH, wW, iH, iW, contentBox, scale;

           contentBox = domGeom.getContentBox(containerNode);
            wH = contentBox.h;
            wW = contentBox.w;
            iH = image.height;
            iW = image.width;
            scale = 1;

            if (wH &gt; 200) {

                wH = wH - 50;
            }
            if (wW&gt; 200) {

                wW = wW - 50;
            }
            if (wH &lt; 50) {

                wH = 100;
            }
            if (wW &lt; 50) {

                wW = 100;
            }
            // if the image is larger than the window
            if(iW&gt;wW &amp;&amp; iH&gt;wH){
                // if the window height is lager than the width
                if (wH &lt; wW) {
                    scale = 1-((iH - wH) / iH);
                } else { // if the window width is lager than the height
                    scale = 1-((iW - wW) / iW);
                }
            } else if (iW &gt; wW) {// if the image  width is lager than the height
                scale =1-((iW - wW) / iW);
            }
            else if (iH &gt; wH) {// if the image  height is lager than the width 
                 scale = 1-((iH - wH) / iH);
            } else {
               //Image is samller than view
                if (wH / iH &gt; wW / iW) {
                    scale = 1+((wH - iH) / wH);
                } else {
                    scale = 1+((wW - iW) / wW);
                }
            }
            image.height = 0.90 *scale * iH;
            image.width = 0.90*scale * iW;

        }
    });
});

</pre>
</body>
</html>
